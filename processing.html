<html>
    <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="processing_styles.css">
    <script src="plotly.min.js"></script>
    </head>
    <body>
    <div class="wrapper">
        <div class="video-processor">
            <p><i>Source Video</i></p>
            <video id="input-video" src="pulse_video.mp4" autoplay muted></video>
            <p><i>Output Canvas</i></p>
            <canvas id="output-canvas"></canvas>
        </div>
        <div class="navbar"><span>Real-Time Chart with Plotly.js</span></div>
            <div id="red_plot"></div>
        <script>
            // Video Processing functions
            function init() {
                video = document.getElementById('input-video');
                red_value = [];

                c1 = document.getElementById('output-canvas');
                ctx1 = c1.getContext('2d');

                c_tmp = document.createElement('canvas');
                c_tmp.setAttribute('width', 300);
                c_tmp.setAttribute('height', 350);
                ctx_tmp = c_tmp.getContext('2d');

                video.addEventListener('play', computeFrame);
                return red_value;
            }

            function computeFrame() {
                if (video.paused || video.ended) {
                return;
                }
                ctx_tmp.drawImage(video, 0, 0, video.videoWidth , video.videoHeight );
                let frame = ctx_tmp.getImageData(0, 0, video.videoWidth , video.videoHeight );

                let red_frame = [];
                for (let i = 0; i < frame.data.length /4; i++) {
                    red_frame.push(frame.data[i * 4]);
                }
                let redAverage = 0;
                for (let i = 0; i < red_frame.length; i++){
                    redAverage += red_frame[i];
                }
                redAverage = redAverage / red_frame.length;
                red_value.push(redAverage);
                ctx1.putImageData(frame, 0, 0);
                setTimeout(computeFrame, 0);
            }

            // ---Main Method---
            let video, c1, ctx1, c_tmp, ctx_tmp, red_value;
            
            red_value = init();
            console.log("Finished processing video...");
            console.log(red_value);

            let csvContent = "data:text/csv;charset=utf-8," 
            + red_value.map(e => e.join(",")).join("\n");

            var encodedUri = encodeURI(csvContent);
            window.open(encodedUri);
            // Create points for plotting red value
            frame_point = [];
            for (let i = 0; i < red_value.length; i++){
                frame_point[i] = i;
            }
            var plot_trace = {
                x: frame_point,
                y: red_value,
                mode: 'line',
                type: 'scatter'
            };

            // Plotly chart
            console.log("Starting plot...");
            Plotly.newPlot('red_plot', [plot_trace]);
        </script>
    </div>
    </body>
</html>
